@model IEnumerable<SAPPub.Web.Controllers.HomeController.School>
@using System.Globalization
@{
    ViewData["Title"] = "Primary schools near me";

    var inv = CultureInfo.InvariantCulture;

    // Settings used by BOTH JS and <noscript> fallback
    var radiusMiles = 3;
    var dataUrl = Url.Content("~/map/schools");
    var fixedZoom = 14;

    // Fallback location 
    var fallbackLat = 51.5099;
    var fallbackLon = -0.0141;

    // Simple Haversine for no-JS fallback distances
    double HaversineMiles(double lat1, double lon1, double lat2, double lon2)
    {
        double ToRad(double d) => Math.PI * d / 180.0;
        const double Rmiles = 3958.7613;
        var dLat = ToRad(lat2 - lat1);
        var dLon = ToRad(lat2 - lon1);
        var a = Math.Pow(Math.Sin(dLat / 2), 2) +
                Math.Cos(ToRad(lat1)) * Math.Cos(ToRad(lat2)) * Math.Pow(Math.Sin(dLon / 2), 2);
        var c = 2 * Math.Asin(Math.Sqrt(a));
        return Rmiles * c;
    }

    var withDistances = Model
        .Select(s => new
        {
            s.Name,
            s.Lat,
            s.Lon,
            Miles = HaversineMiles(fallbackLat, fallbackLon, s.Lat, s.Lon)
        })
        .OrderBy(x => x.Miles)
        .ToList();

    var closest = withDistances.FirstOrDefault();
    var within = withDistances.Where(x => x != closest && x.Miles <= radiusMiles)
                              .OrderBy(x => x.Miles)
                              .ToList();
}

<div>

    <h1 class="govuk-heading-l">@ViewData["Title"]</h1>

    <!-- GOV.UK Demo-mode notification banner -->

            <h2 class="govuk-notification-banner__title" id="demo-mode-title">
                Demo mode
            </h2>
        
            <p class="govuk-body govuk-notification-banner__heading">
                This map uses a fixed demonstration location in Sheffield.
            </p>
            <p class="govuk-body">
                Location services are disabled so everyone sees the same example data.
            </p>

    <!-- End banner -->
    <!-- Interactive map (hidden if JS is off) -->
    <div id="map"
         data-radius-miles="@radiusMiles"
         data-data-url="@dataUrl"
         data-fixed-zoom="@fixedZoom"
         data-fallback-lat="@fallbackLat.ToString(inv)"
         data-fallback-lon="@fallbackLon.ToString(inv)"
         role="region"
         aria-label="Map of primary schools near you">
        <div class="map-loading">Finding your location…</div>
    </div>

    <!-- 🔻 Non-JavaScript fallback -->
    <noscript>

        <!-- Banner for users with JS disabled -->
        <div class="govuk-notification-banner govuk-notification-banner--info"
             role="region" aria-labelledby="demo-mode-title-noscript">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="demo-mode-title-noscript">
                    Demo mode
                </h2>
            </div>
            <div class="govuk-body govuk-notification-banner__content">
                <p class="govuk-body govuk-notification-banner__heading">
                    This map uses a fixed demonstration location in Sheffield.
                </p>
                <p class="govuk-body">
                    JavaScript is disabled, so geolocation and interactive features are unavailable.
                </p>
            </div>
        </div>
        <!-- End noscript banner -->

        <style>
            #map, .legend {
                display: none !important;
            }

            .map-noscript {
                margin-top: 1rem;
                background: #f3f4f6;
                padding: .75rem;
                border-radius: .5rem;
                text-align: center;
            }

                .map-noscript img {
                    display: block;
                    margin: .5rem auto;
                    border-radius: .5rem;
                    max-width: 100%;
                    height: auto;
                }

                .map-noscript ul {
                    list-style: disc;
                    margin: .5rem 1rem;
                    text-align: left;
                }
        </style>

        <div class="map-noscript">
            <p>
                JavaScript is disabled. Below is a list of nearby primary schools.
            </p>

            @if (closest is not null)
            {
                <h2 class="h5" style="margin-top:1rem;">Closest primary school</h2>
                <p>
                    <strong>@closest.Name</strong><br />
                    @closest.Miles.ToString("0.00") miles away
                </p>
            }

            <h2 class="h5" style="margin-top:1rem;">Other primary schools within @radiusMiles miles</h2>
            @if (within.Any())
            {
                <ul>
                    @foreach (var s in within)
                    {
                        <li>
                            <strong>@s.Name</strong> — @s.Miles.ToString("0.00") miles away
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>No other primary schools within @radiusMiles miles.</p>
            }
        </div>
    </noscript>

    <!-- JS legend (hidden if JS off) -->
    <div class="legend">
        <div class="legend-item">
            <img src="~/assets/images/marker-user.svg" alt="" />
            <span>Your location</span>
        </div>
        <div class="legend-item">
            <img src="~/assets/images/marker-school-target.svg" alt="" />
            <span>Nearest Primary School</span>
        </div>
        <div class="legend-item">
            <img src="~/assets/images/marker-school-nearby.svg" alt="" />
            <span>Other primary schools within @radiusMiles miles</span>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/map-schools.js"></script>
}
